var sha256 =require('sha256');
var cradle = require('cradle');
var conn=new(cradle.Connection)('aap.cloudant.com', {
      auth: { username: 'aap', password: 'la82pi37' }
  });
var enc = conn.database('js_ugr_encuesta');
enc.exists(function (err, exists) {
	if (err) {
		console.log('error', err);
	} else if (!exists) {
		enc.create();
	} 
});

enc.save('_design/respuestas', {
	views: {
	   "resultados": {
		   "map": "function(doc) {\n  emit(null, doc);\n}"
	   }
	},		
	lists: { 
		media: function(head, req) {  		    

			start({"headers": {"Content-Type": "application/json"}});	
			var row;  
			var totales=[0,0,0,0,0,0,0];
			var respuesta={};
			respuesta.resultados=[];
			var i=0;		    

			while(row = getRow()) {
				i=i+1;
				if(row.value.respuesta1)
				totales[0]=totales[0]+parseInt(row.value.respuesta1);
				if(row.value.respuesta2)
				totales[1]=totales[1]+parseInt(row.value.respuesta2);
				if(row.value.respuesta3)
				totales[2]=totales[2]+parseInt(row.value.respuesta3);
				if(row.value.respuesta4)
				totales[3]=totales[3]+parseInt(row.value.respuesta4);
				if(row.value.respuesta5)
				totales[4]=totales[4]+parseInt(row.value.respuesta5);
				if(row.value.respuesta6)
				totales[5]=totales[5]+parseInt(row.value.respuesta6);
				if(row.value.respuesta7)
				totales[6]=totales[6]+parseInt(row.value.respuesta7);
			}
			send('{"respuesta1": '+totales[0]/i+', "respuesta2": '+totales[1]/i+', "respuesta3": '+totales[2]/i+', "respuesta4": '+totales[3]/i+', "respuesta5": '+totales[4]/i+', "respuesta6": '+totales[5]/i+', "respuesta7": '+totales[6]/i+', "encuestas": '+i+'}');
		} 	
	}
});

var users = conn.database('js_ugr_users');
users.exists(function (err, exists) {
	if (err) {
		console.log('error', err);
	} else if (!exists) {
		users.create();
	} 
});

users.save('_design/oldEntries', {
	views: {
	   "expiration": {
		   "map": "function(doc) {\n  emit(doc.validated, doc.expiration);\n}"
	   }
	},		
	lists: { 
		combine: function(head, req) {  		    

			start({"headers": {"Content-Type": "application/json"}});	
			var row;  
			var respuesta={};
					while(row = getRow()) {
				respuesta[row.id]={validated: row.key, expiration: row.value};
			}
			send(JSON.stringify(respuesta));
		} 	
	}
});


var data = conn.database('js_ugr_docs');
data.exists(function (err, exists) {
	if (err) {
		console.log('error', err);
	} else if (!exists) {
		data.create();
	} 
});

var cache = conn.database('js_ugr_usercache');
data.exists(function (err, exists) {
	if (err) {
		console.log('error', err);
	} else if (!exists) {
		cache.create();
	} 
});
